# Feature Specification: Advanced Oracle Draw Button

**Feature Branch**: `050-oracle-draw-button`  
**Created**: 2026-02-19  
**Status**: Draft  
**Input**: User description: "if advanced oracle, lets have a draw button https://github.com/eserlan/Codex-Cryptica/issues/191"

## User Scenarios & Testing _(mandatory)_

### User Story 1 - One-Click Visualization (Priority: P1)

As an Advanced Tier user, I want a "Draw" button to appear on Oracle responses so that I can instantly visualize the descriptions provided by the AI without typing a separate command.

**Why this priority**: Core value for Advanced tier users. It reduces friction between lore generation and visual immersion.

**Independent Test**: Can be fully tested by switching to Advanced tier, asking the Oracle for a description, and verifying the "Draw" button triggers image generation.

**Acceptance Scenarios**:

1. **Given** I am in the Advanced tier, **When** the Oracle generates a text response, **Then** a "Draw" button is visible at the bottom of the message.
2. **Given** I see a "Draw" button, **When** I click it, **Then** the system starts generating an image using the message content as a prompt.

---

### User Story 2 - Tier-Based UI Differentiation (Priority: P2)

As a Lite user, I should not see the "Draw" button, ensuring that Advanced features are clearly bounded and do not clutter the basic interface.

**Why this priority**: Maintains clear tier boundaries and avoids user confusion about unavailable features.

**Independent Test**: Switch to Lite tier and verify the "Draw" button is absent from Oracle responses.

**Acceptance Scenarios**:

1. **Given** I am in the Lite tier, **When** the Oracle generates a response, **Then** no "Draw" button appears.

---

### User Story 3 - Visualizing Existing Lore (Priority: P1)

As a World Builder who has imported text-only campaign data, I want a "Draw" button in the Entity Detail Panel and Zen Mode so that I can generate visuals for entities that currently lack artwork.

**Why this priority**: High value for content migration. It allows users to "upgrade" their imported text-heavy campaigns with AI-generated visuals seamlessly.

**Independent Test**: Open an entity that has a description but no image, verify the "Draw" button is present in both the sidepanel and Zen mode, and ensure it correctly triggers generation.

**Acceptance Scenarios**:

1. **Given** an entity with a description but no image, **When** I view it in the sidepanel or Zen mode, **Then** a "Draw" button is visible in the header or image placeholder area.
2. **Given** I am in Zen mode, **When** I click "Draw", **Then** an image is generated based on the entity's lore and automatically assigned to that entity.

---

### Edge Cases

- What happens if the Oracle response is very short? (Assumption: Button still appears, but prompt might be limited).
- How does the system handle image generation failure after the button is clicked? (Assumption: Display error message and allow retry).
- Can a user click "Draw" multiple times? (Assumption: Button should be disabled or replaced during generation).

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: System MUST display a "Draw" action button on all text messages generated by the Oracle assistant.
- **FR-002**: System MUST display a "Draw" action button in the Entity Detail Sidepanel and Zen Mode for entities that do not currently have an assigned image.
- **FR-003**: System MUST only display these buttons when the `tier` in the `OracleStore` is set to `advanced`.
- **FR-004**: Clicking the "Draw" button MUST trigger the image generation workflow using the content of the associated message or entity lore as the visual context.
- **FR-005**: System MUST show a persistent loading indicator within the UI container (chat message, sidepanel, or Zen mode) while image generation is in progress.
- **FR-006**: Once generated, the image MUST be displayed within the same context, replacing the "Draw" button.
- **FR-007**: Images generated from the Entity Detail Sidepanel or Zen Mode MUST be automatically saved to the vault and associated with the active entity.
- **FR-008**: System MUST automatically ground all "Draw" actions against any "Art Style" or "Visual Aesthetic" notes found in the vault to ensure stylistic consistency.
- **FR-009**: System SHOULD provide a "Style Grounding Indicator" (e.g., a tooltip or status text) indicating that a "Global Art Style" is being applied to the generation.
- **FR-010**: System MUST persist the state of the "Draw" button (or the resulting image) in the chat history.

### Key Entities

- **ChatMessage**: Updated to track whether a "Draw" action was triggered and store the resulting image reference.
- **OracleStore**: Manages the tier state and coordinates the generation trigger.

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 100% of Oracle text responses in Advanced tier provide a "Draw" button.
- **SC-002**: 100% of entities without images display a "Draw" button in the Detail Sidepanel and Zen Mode when in Advanced tier.
- **SC-003**: Users can trigger image generation with exactly 1 click from any of the three locations.
- **SC-004**: UI feedback (loading state) appears within 200ms of clicking the button.
- **SC-005**: 100% of generated images respect detected "Art Style" guides if they exist in the vault.
- **SC-006**: Zero occurrences of the "Draw" button appearing for Lite tier users in any part of the application.
