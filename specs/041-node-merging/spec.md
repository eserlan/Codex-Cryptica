# Feature Specification: Node Merging

**Feature Branch**: `041-node-merging`  
**Created**: 2026-02-13  
**Status**: Draft  
**Related Issue**: [#123](https://github.com/eserlan/Codex-Cryptica/issues/123)  
**Input**: User description: "Merge nodes/entities, especially useful after imports. Use AI to consolidate descriptions."

## User Scenarios & Testing

### User Story 1 - Merge Duplicate Nodes (Priority: P1)

As a user, I want to select multiple nodes and merge them into a single node so that I can eliminate duplicates and consolidate information.

**Why this priority**: Core functionality requested to handle duplicate content after imports.

**Independent Test**:

1. Create two nodes with slightly different content but referring to the same entity.
2. Select both nodes in the graph or list view.
3. Initiate a "Merge" action.
4. Verify that a new node is created (or one is updated) containing combined information, and the original duplicates are removed.

**Acceptance Scenarios**:

1. **Given** two nodes "Ancient Dragon" and "The Old Dragon" exist, **When** I select both and click "Merge", **Then** a merge interface appears showing the source nodes.
2. **Given** the merge interface is open, **When** I confirm the merge, **Then** a single node remains, and the other is deleted.
3. **Given** the merge is complete, **When** I check the connections, **Then** connections from both original nodes are preserved in the merged node.

### User Story 2 - AI-Assisted Content Consolidation (Priority: P1)

As a user, I want the system to automatically generate a consolidated description for the merged node using AI, so that I don't have to manually copy-paste and edit text.

**Why this priority**: Essential for usability, as manually merging content is tedious.

**Independent Test**:

1. Select nodes to merge.
2. The system presents a preview of the merged content generated by AI.
3. The generated content should include key information from all source nodes.

**Acceptance Scenarios**:

1. **Given** two nodes with distinct details, **When** I initiate a merge, **Then** the suggested description contains a coherent summary of both.
2. **Given** the AI suggestion is generated, **When** I edit the suggestion manually, **Then** my edits are preserved in the final merged node.

### User Story 3 - Link Redirection (Priority: P2)

As a user, I want links pointing to the original nodes to be automatically updated to point to the merged node, so that my knowledge graph remains consistent.

**Why this priority**: Important for data integrity but could be a fast-follow if needed (though highly recommended for MVP to avoid broken links).

**Independent Test**:

1. Create Node A and Node B (to be merged).
2. Create Node C that links to Node A.
3. Merge Node A and Node B into Node AB.
4. Verify Node C now links to Node AB.

**Acceptance Scenarios**:

1. **Given** Node C links to Node A, **When** Node A is merged into Node B, **Then** Node C's link is updated to point to Node B.

### Edge Cases

- **Conflicting Metadata**: If source nodes have different "types" or conflicting frontmatter, the AI should propose a resolution, but the user must verify. Default to the "primary" (target) node's type if not specified.
- **Open in Editor**: If a node to be merged is currently open with unsaved changes, the system should prompt to save or discard before merging.
- **AI Failure**: If the AI service is unavailable, the merge should still proceed with a concatenation of content (manual fallback).
- **Self-Merge**: The system must prevent selecting the same node multiple times or merging a node into itself.
- **Large Content**: Extremely large nodes might exceed AI context windows; the system should handle truncation or warn the user.

## Requirements

### Functional Requirements

- **FR-001**: Users MUST be able to select 2 or more nodes to merge from the graph or list view.
- **FR-002**: The system MUST fetch the full content (frontmatter and body) of all selected nodes.
- **FR-003**: The system MUST use the configured AI provider to generate a consolidated name, type, and description/body for the merged node.
- **FR-004**: Users MUST be presented with a preview of the merged node (name, content, tags) before committing.
- **FR-005**: Users MUST be able to edit the merged content before confirming.
- **FR-006**: Upon confirmation, the system MUST delete the original nodes and create/update the target node.
- **FR-007**: The system MUST identify all incoming and outgoing connections of the original nodes and transfer them to the merged node.
- **FR-008**: The system MUST update any internal links (wikilinks) in other nodes that pointed to the deleted nodes.
- **FR-009**: The system MUST include a user-facing help article and feature hint explaining the merge process and strategies.

## Success Criteria

### Measurable Outcomes

- **SC-001**: Merging 2 nodes takes less than 5 seconds (excluding AI generation time).
- **SC-002**: 100% of connections from source nodes are present in the destination node.
- **SC-003**: Zero broken links result from a merge operation.
